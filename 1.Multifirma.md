# Multifirma usando la linea de comandos de Bitcoin Core.

## Introduccion
En esta parte veremos como usando los comandos de Bitcoin Core generamos una dirección de Bitcoin multifirma y crearemos una transacción PSBT para gastar el BTC bloqueado en la multifirma.

## Requisitos:
Sistema operativo Linux. Para este ejemplo he usado Debian 12
Bitcoin core version 30.0
Configurar Bitcoin Core en modo regtest.
JSON

## Antecedentes:
En anteriores versiones para hacer una transaccion multifirma usabamos las comandos  addmultisigaddress, importmulti, importprivkey o dumpkey, algunos de estas han desaparecido y los wallet con los que trabajamos ahora son HD (Hierarchical Deterministic), las direcciones se generan usando un descriptor. En este tutorial usaremos estos descriptors para generar direcciones multifirma.

Tenemos varias formas de hacer una transaccion multifirma y hay cinco fases que tenemos que completar: crear transaccion, actualizar, firmar, finalizar y extraer. Vamos a ver ahora dos metodos:

### Metodo 1 - PSBT y walletcreatefundedpsbt

Para crear y actualizar, usamos el comando walletcreatefundedpsbt.
Para firmar y finalizar usamos el comando walletprocesspsbt.
Para extraer usamos el comando finalizepsbt

Para poder usar el comando walletcreatefundedpsbt creamos un wallet e importamos los descriptors internos y externos, de esta forma podemos ver el balance de nuestra mutlfirma. Necesitamos los descriptors internos porque walletprocesspsbt nos va a crear una direccion de cambio con estos descritptor internos.

Importante: estamos usando la red de pruebas, en la red de Bitcoin recomiendo añadir al comando walletcreatefundedpsbt el argumentos fee_rate en sat/vB o feeRate en BTC/kvB.

### Metodo 2 - PSBT y utxoupdate

Para crear: createpsbt.
Para actualizar utxoupdatepsbt.
Para firmar y finalizar walletprocesspsbt
Paraa extraer finalizepsbt.

Vamos a crear un wallet multifirma, con este método no necesitamos los descriptors internos, ya que no vamos a utilizar una dirección de cambio, al tener mas control sobre la transacción, tenemos que tener cuidado con los fees.

## Entendiendo los comandos
En la página oficial https://bitcoincore.org/en/doc/30.0.0/ encontrarás los comandos que vamos a utilizar para entender mejor este tutorial: listdescriptors, getdescriptorinfo, importdescriptors, walletcreatefundedpsbt, walletprocesspsbt, combinepsbt, finalizepsbt.

## Metodo 1 paso a paso

Creamos dos direcciones  de Alice y Bob

```
$bitcoin-cli createwallet "Alice"
$bitcoin-cli createwallet "Bob"
```

Obtenemos los descriptors de Alice y Bob internos y externos.

```
descAext=$(bitcoin-cli -rpcwallet=Alice listdescriptors | jq -r '.descriptors | [.[] | select(.desc | startswith("pkh") and contains("/0/*"))][0] | .desc'| grep -Po '(?<=\().*(?=\))')
descAint=$(bitcoin-cli -rpcwallet=Alice listdescriptors | jq -r '.descriptors | [.[] | select(.desc | startswith("pkh") and contains("/1/*"))][0] | .desc'| grep -Po '(?<=\().*(?=\))')
```

Repetimos el proceso con el wallet de Bob

```
$descBint=$(bitcoin-cli -rpcwallet=Bob listdescriptors | jq -r '.descriptors | [.[] | select(.desc | startswith("pkh") and contains("/1/*"))][0] | .desc'| grep -Po '(?<=\().*(?=\))')
$descBext=$(bitcoin-cli -rpcwallet=Bob listdescriptors | jq -r '.descriptors | [.[] | select(.desc | startswith("pkh") and contains("/0/*"))][0] | .desc'| grep -Po '(?<=\().*(?=\))')
```

Ahora vamos a crear el descriptor de nuestro wallet multifirma para ello usaremos la funcion multi, tanto para el interno como para el externo.

```
$extdesc="wsh(multi(2,$descAext,$descBext))"
$intdesc="wsh(multi(2,$descAint,$descBint))"
```

Necesitamos añadir el checksum  de nuestro descriptor multifirma, esto lo conseguimos  con getdescriptorinfo

```
$extdescsum=$(bitcoin-cli getdescriptorinfo $extdesc | jq -r  '.descriptor')
$intdescsum=$(bitcoin-cli  getdescriptorinfo $intdesc | jq -r '.descriptor')
```

Creamos un wallet en blanco para poder importar nuestro descriptor

```
$bitcoin-cli -named createwallet wallet_name="multi" disable_private_keys=true blank=true
```

Importamos los descriptors

```
$bitcoin-cli  -rpcwallet="multi" importdescriptors "[{\"desc\": \"$extdescsum\",\"timestamp\": \"now\",\"active\": true,\"watching-only\": true,\"internal\": false,\"range\": [0,999]} , {\"desc\": \"$intdescsum\",\"timestamp\": \"now\",\"active\": true,\"watching-only\": true,\"internal\": true,\"range\": [0,999]}]"
```

Ya podemos obtener una direccion de nuestro wallet

```
$direccionmulti=$(bitcoin-cli -rpcwallet="multi" getnewaddress)
```

Enviamos unos BTC regtest a nuestro wallet multi y después enviamos desde nuestro  wallet Multi a Alice

```
$direccionAlice=$(bitcoin-cli -rpcwallet="Alice" getnewaddress)
```

Creamos la transaccion psbt con el comando walletcreatefundedpsbt

```
$psbt=$(bitcoin-cli -rpcwallet="multi" -named walletcreatefundedpsbt inputs="[{\"txid\": \"$identtx\",\"vout\":0}]" outputs="[{\"$direccionAlice\":39.999}]" | jq -r '.psbt')
```

Alice y Bob  pueden firmar por separado y combinar las firmas

```
$psbtA=$(bitcoin-cli -rpcwallet="Alice" walletprocesspsbt $psbt | jq -r '.psbt')
$psbtB=$(bitcoin-cli -rpcwallet="Bob" walletprocesspsbt $psbt | jq -r '.psbt')

$combinedpsbt=$(bitcoin-cli combinepsbt "[\"$psbtA\", \"$psbtB\"]")

$finalizedpsbt=$(bitcoin-cli finalizepsbt $combinedpsbt | jq -r '.hex')

$bitcoin-cli sendrawtransaction $finalizedpsbt
```

Podemos minar unos Bitcoin en Regtest y ver los saldos de Alice y Multi para comprobar que se ha realizado la transaccion, verás que el cambio de la transacción se ha enviado a una dirección de cambio del wallet multi.

### Metodo 2 paso a paso

Creamos los wallets de Alice y Bob como en el método 1, pero esta vez solo extraemos los descriptors externos y en el wallet multifirma importamos solo los descriptors externos.

```
extdesc="wsh(multi(2,$descAext,$descBext))"
extdescsum=$(bitcoin-cli getdescriptorinfo $extdesc | jq -r  '.descriptor')
bitcoin-cli -named createwallet wallet_name="multi" disable_private_keys=true blank=true
bitcoin-cli  -rpcwallet="multi" importdescriptors "[{\"desc\": \"$extdescsum\",\"timestamp\": \"now\",\"active\": true,\"watching-only\": true,\"internal\": false,\"range\": [0,999]}]"
```

Enviamos unos BTC a la dirección multfirma y creamos la transacción, esta vez tenemos que estar pendientes de los fees ya que la transacción se crea en crudo y se hace la actualización "update" con el comando utxoupdatepsbt.
```
psbt=$(bitcoin-cli -rpcwallet="multi" -named createpsbt inputs="[{\"txid\": \"$identtx\",\"vout\":0}]" outputs="[{\"$direccionBob\":10},{\"$direccionAlice\":39.999}]")
```
Para actualizar (update) la transacción usamos el descriptor multifirma que creamos antes dentro del comando utxoupdatepsbt.
```
psbtupdate=$(bitcoin-cli utxoupdatepsbt $psbt "[{\"desc\": \"$extdescsum\"}]")
```
El resto del proceso es igual que en el paso 1, con walletprocesspsbt, combinepsbt y finalizepsbt.
```
psbtA=$(bitcoin-cli -rpcwallet="Alice" walletprocesspsbt $psbtupdate | jq -r '.psbt')
psbtB=$(bitcoin-cli -rpcwallet="Bob" walletprocesspsbt $psbtupdate | jq -r '.psbt')
```
Combinar psbtA y psbtB, se finaliza y se envia.
```
combinedpsbt=$(bitcoin-cli combinepsbt "[\"$psbtA\", \"$psbtB\"]")
finalizedpsbt=$(bitcoin-cli finalizepsbt $combinedpsbt | jq -r '.hex')
bitcoin-cli sendrawtransaction $finalizedpsbt
```

## Conclusion

Con este tutorial hemos aprendido a hacer una transaccion multifirma. Ahora sabemos usar los descritors para crear transacciones mas complejas con miniscripts y a usarlos para firmar offline.

## Enlaces
Enlaces de interes usados para hacer este tutorial
https://diyhpl.us/wiki/transcripts/advancing-bitcoin/2020/2020-02-06-andrew-chow-descriptor-wallets/ En este enlace puedes aprender mas detalles sobre los descriptors.
https://github.com/bitcoin/bitcoin/blob/master/doc/descriptors.md#multisig
https://github.com/bitcoin/bitcoin/blob/master/doc/multisig-tutorial.md
https://github.com/bitcoin/bitcoin/blob/master/doc/descriptors.md En este enlace verás una lista de miniscripts implementados en Bitcoin Core.
https://bitcoincore.org/en/doc/30.0.0/rpc/wallet/walletcreatefundedpsbt/

Continua ahora con la guia para hacer transacciones con miniscript:

[Guia Miniscripts con descriptors](/2.Miniscript.md)